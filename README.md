# ブラウザ操作エージェント

このプロジェクトは、自然言語指示でブラウザを操作するAIエージェントです。Streamlitベースのインターフェースから、Webブラウザを自動的に操作できます。

## 構成

リファクタリング後のプロジェクト構成は以下の通りです：

```
browser-agent/
├── agent/                 # エージェントコードディレクトリ
│   ├── __init__.py        # パッケージ初期化
│   ├── app.py             # メインアプリケーションコード
│   ├── api_client.py      # Bedrock API連携
│   ├── browser_tools.py   # ブラウザ操作ツール
│   ├── main.py            # エージェントパッケージのエントリーポイント
│   ├── prompts.py         # プロンプト定義
│   └── utils.py           # ユーティリティ関数
├── credentials/           # 認証情報ディレクトリ
│   └── aws_credentials.json # AWS認証情報 (gitignoreに追加すること)
├── tests/                 # テスト用スクリプト
│   └── test_initialize_browser.py
├── main.py                # プロジェクトのメインエントリーポイント
├── requirements.txt       # 依存ライブラリ
└── README.md              # このファイル
```

## 機能
- Webブラウザの自動操作
- チャットベースのインターフェース
- 検索、クリック、フォーム入力などの操作
- スクリーンショット撮影機能
- リンク抽出機能
- 型指定なしのメッセージでも、`text`キーがあればテキストとして正しく表示する改善
- Converse APIのツール呼び出し処理を改善し、`stopReason`が`end_turn`になるまでツール実行と再呼び出しを繰り返すループ処理を実装

## 使用方法
1. 環境構築
```bash
pip install -r requirements.txt
playwright install chromium
```

2. credentialsディレクトリにaws_credentials.jsonを配置
```json
{
  "aws_access_key_id": "あなたのAWSアクセスキー",
  "aws_secret_access_key": "あなたのAWSシークレットキー"
}
```

3. アプリケーションの起動
```bash
streamlit run main.py
```

4. ブラウザで指示を入力
   - 例: 「Amazonで商品を検索して」
   - 例: 「ニュースサイトを開いて最新記事を教えて」

## テスト
テスト用スクリプトは `tests/` ディレクトリに配置されています。ブラウザ初期化を確認するには以下のコマンドを実行してください：
```bash
cd browser-agent
streamlit run tests/test_initialize_browser.py
```

## 技術仕様
- Streamlit: UIフレームワーク
- Playwright: ブラウザ自動化
- Amazon Bedrock: AI応答生成
- Claude 3 Sonnet: メインモデル

## 注意事項

- このアプリケーションを実行するには、有効なAWS Bedrockのアクセス権が必要です
- Claude 3.7 Sonnetモデルへのアクセス権が必要です

## 概要

このプロジェクトは、自然言語での指示に基づいてウェブブラウザを自動操作するAIエージェントです。Amazon Bedrock の Claude と連携して、ユーザーの要求を理解し、ウェブブラウザ上での操作（クリック、テキスト入力、ページ移動など）を自動実行します。

## 特徴

- **自然言語による操作指示**: 「Googleで猫の画像を検索して」のような自然な指示でブラウザを操作
- **視覚的フィードバック**: 操作の各ステップでスクリーンショットを撮影し、視覚的に結果を確認
- **段階的な操作実行**: 複雑なタスクを小さなステップに分解して実行
- **対話型インターフェース**: Streamlitベースの使いやすいチャットインターフェース
- **エラー回復機能**: 操作に失敗した場合、別のアプローチを試行
- **詳細なデバッグログ**: 各関数の処理内容や状態をリアルタイムで確認可能なログ表示機能

## 技術スタック

- **フロントエンド**: Streamlit（対話型WebUI）
- **AIモデル**: Amazon Bedrock (Claude 3.7 Sonnet)
- **ブラウザ制御**: 専用ブラウザサービスAPI
- **開発言語**: Python

## 主な機能

1. **スクリーンショット撮影**: 現在のブラウザ画面を視覚的に確認
2. **ページ内容取得**: Webページのテキスト、要素などを取得
3. **要素クリック**: ボタン、リンクなどを自然言語で指定してクリック
4. **テキスト入力**: フォームフィールドなどにテキストを入力
5. **ページ移動**: 指定URLへの移動
6. **要素検索**: 特定の条件に合致する要素を検索

## セットアップ方法

### 前提条件

- Python 3.8以上
- AWS認証情報（Amazon Bedrockへのアクセス権限を持つ）
- ブラウザ操作サービス（別途セットアップが必要）

### インストール手順

1. リポジトリをクローン
   ```
   git clone https://github.com/yourusername/browser-agent.git
   cd browser-agent
   ```

2. 依存パッケージのインストール
   ```
   pip install -r requirements.txt
   ```

3. AWS認証情報の設定
   プロジェクトには既に`credentials/aws_credentials.json`ファイルが用意されています。このファイルを実際のAWS認証情報で更新してください。
   
   ```json
   {
     "aws_access_key_id": "your_access_key",
     "aws_secret_access_key": "your_secret_key",
     "region_name": "us-west-2"
   }
   ```
   
   * `your_access_key`をあなたのAWSアクセスキーに置き換えてください
   * `your_secret_key`をあなたのAWSシークレットキーに置き換えてください
   * 必要に応じて`region_name`も適切なリージョンに変更してください

   > 注意: AWS認証情報は機密情報です。このファイルをGitリポジトリにコミットしないよう注意してください。

4. ブラウザサービスのセットアップ（別途手順を参照）

### 実行方法

```
cd browser-agent
streamlit run agent/agent.py
```

## ブラウザサービスの設定

ブラウザ操作エージェントは別途実行されるブラウザ制御サービスとHTTP APIで連携します。
デフォルトでは `http://localhost:5000` で接続を試みます。

接続先を変更するには環境変数を設定します:

```
export BROWSER_SERVICE_URL="http://your-browser-service-url"
```

## 使用例

1. アプリケーションを起動
2. サイドバーで接続状態を確認
3. URLフォームからブラウジングを開始するか、直接指示を入力
4. 例: 「Amazonにアクセスして、ヘッドフォンを検索して」
5. AIが段階的に操作を実行し、各ステップの結果を表示
6. 右側のデバッグログパネルで詳細な処理内容を確認

## デバッグログ機能

アプリケーションには詳細なデバッグログ機能が実装されています。

### 機能概要

- **リアルタイムログ表示**: 処理中の操作やAPI呼び出しなどの詳細情報をリアルタイムで表示
- **関数別グループ化**: 各関数ごとにログをグループ化して表示
- **JSON形式対応**: 複雑なデータ構造もJSON形式で見やすく表示
- **ログクリア機能**: 「ログをクリア」ボタンでログをリセット可能

### 表示されるログ情報

- **Bedrock API呼び出し**: リクエスト詳細とレスポンス内容
- **ブラウザ操作ツール**: 各ツールの実行状態と結果
- **会話処理**: 会話の進行状況やターン管理の詳細
- **エラー情報**: 発生したエラーの詳細とスタックトレース

### 開発者向け情報

新しい関数を追加する場合は、`add_debug_log`関数を使用してログを記録できます。

```python
# 文字列メッセージをログに記録
add_debug_log("ログメッセージ", "グループ名")  # グループ名は省略可能（省略時は呼び出し元関数名を使用）

# dictやlistを直接渡せます（json.dumps不要）
data = {"key": "value", "nested": {"number": 123}}
add_debug_log(data, "グループ名")
```

## 注意事項

- ブラウザサービスが別途必要です（このリポジトリには含まれていません）
- Amazon Bedrockの使用にはAWSアカウントと適切な権限が必要です
- 複雑なJavaScriptを使用したサイトでは一部機能が制限される場合があります

## ライセンス

[ライセンス情報を記載]

## 最終更新: 2025-04-23 00:00:28

### 機能
- Webブラウザの自動操作
- チャットベースのインターフェース
- 検索、クリック、フォーム入力などの操作
- スクリーンショット撮影機能
- リンク抽出機能

### 使用方法
1. サイドバーからモデルを選択
2. チャット入力欄にブラウザ操作の指示を入力
3. 結果を確認

### 技術仕様
- Streamlit: UIフレームワーク
- Playwright: ブラウザ自動化
- Amazon Bedrock: AI応答生成
- Claude 3 Sonnet: メインモデル
